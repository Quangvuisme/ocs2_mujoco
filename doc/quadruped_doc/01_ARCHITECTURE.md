# 01. System Architecture Overview

## ğŸ“ High-Level Architecture

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                         vm_anymal_standing_online                            â”‚
â”‚                                                                              â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚                        OCS2 Framework Layer                             â”‚ â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚ â”‚
â”‚  â”‚  â”‚ LeggedRobot     â”‚  â”‚ GaussNewtonDDP  â”‚  â”‚ MPC_MRT_Interface       â”‚ â”‚ â”‚
â”‚  â”‚  â”‚ Interface       â”‚  â”‚ _MPC            â”‚  â”‚ (Real-time interface)   â”‚ â”‚ â”‚
â”‚  â”‚  â”‚                 â”‚  â”‚                 â”‚  â”‚                         â”‚ â”‚ â”‚
â”‚  â”‚  â”‚ - URDF parsing  â”‚  â”‚ - DDP solver    â”‚  â”‚ - Observation update    â”‚ â”‚ â”‚
â”‚  â”‚  â”‚ - Pinocchio     â”‚  â”‚ - Rollout       â”‚  â”‚ - Policy evaluation     â”‚ â”‚ â”‚
â”‚  â”‚  â”‚ - Constraints   â”‚  â”‚ - Line search   â”‚  â”‚ - Thread-safe MPC       â”‚ â”‚ â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                                    â”‚                                         â”‚
â”‚                                    â–¼                                         â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚                      Whole Body Controller (WBC)                        â”‚ â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚ â”‚
â”‚  â”‚  â”‚               CentroidalModelRbdConversions                     â”‚   â”‚ â”‚
â”‚  â”‚  â”‚                                                                 â”‚   â”‚ â”‚
â”‚  â”‚  â”‚  Input:  MPC state (24-dim), MPC input (24-dim)                 â”‚   â”‚ â”‚
â”‚  â”‚  â”‚  Output: Joint torques (12-dim)                                 â”‚   â”‚ â”‚
â”‚  â”‚  â”‚                                                                 â”‚   â”‚ â”‚
â”‚  â”‚  â”‚  Formula: Ï„ = RNEA(q, v, a + Kp*e_q + Kd*e_v, F_ext)           â”‚   â”‚ â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                                    â”‚                                         â”‚
â”‚                                    â–¼                                         â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚                        MuJoCo Simulation Layer                          â”‚ â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚ â”‚
â”‚  â”‚  â”‚ Physics Engine  â”‚  â”‚ GUI Renderer    â”‚  â”‚ ANYmal C Model          â”‚ â”‚ â”‚
â”‚  â”‚  â”‚                 â”‚  â”‚                 â”‚  â”‚                         â”‚ â”‚ â”‚
â”‚  â”‚  â”‚ - Rigid body    â”‚  â”‚ - 3D rendering  â”‚  â”‚ - scene.xml             â”‚ â”‚ â”‚
â”‚  â”‚  â”‚ - Contact       â”‚  â”‚ - Camera        â”‚  â”‚ - 12 actuated joints    â”‚ â”‚ â”‚
â”‚  â”‚  â”‚ - Friction      â”‚  â”‚ - UI controls   â”‚  â”‚ - 4 legs                â”‚ â”‚ â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ§µ Thread Model

The system uses **3 concurrent threads** plus the main GUI thread:

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                              THREAD DIAGRAM                                 â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                             â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚                     Main Thread (GUI)                               â”‚   â”‚
â”‚  â”‚                                                                     â”‚   â”‚
â”‚  â”‚   sim->RenderLoop()                                                 â”‚   â”‚
â”‚  â”‚   - Handles user input (Space, Backspace, ESC)                      â”‚   â”‚
â”‚  â”‚   - Renders 3D view                                                 â”‚   â”‚
â”‚  â”‚   - Updates UI                                                      â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                                             â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚    MPC Thread      â”‚ â”‚  Control Thread    â”‚ â”‚   Physics Thread       â”‚  â”‚
â”‚  â”‚    (50 Hz)         â”‚ â”‚  (1000 Hz)         â”‚ â”‚   (variable Hz)        â”‚  â”‚
â”‚  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤ â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤ â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤  â”‚
â”‚  â”‚                    â”‚ â”‚                    â”‚ â”‚                        â”‚  â”‚
â”‚  â”‚ mpcThread()        â”‚ â”‚ controlThread()    â”‚ â”‚ physicsThread()        â”‚  â”‚
â”‚  â”‚                    â”‚ â”‚                    â”‚ â”‚                        â”‚  â”‚
â”‚  â”‚ while(!exit):      â”‚ â”‚ while(!exit):      â”‚ â”‚ while(!exit):          â”‚  â”‚
â”‚  â”‚   advanceMpc()     â”‚ â”‚   get state        â”‚ â”‚   load model           â”‚  â”‚
â”‚  â”‚   sleep(1ms)       â”‚ â”‚   evaluate policy  â”‚ â”‚   step physics         â”‚  â”‚
â”‚  â”‚                    â”‚ â”‚   compute WBC      â”‚ â”‚   update observation   â”‚  â”‚
â”‚  â”‚                    â”‚ â”‚   apply torques    â”‚ â”‚   sync time            â”‚  â”‚
â”‚  â”‚                    â”‚ â”‚   sleep(1ms)       â”‚ â”‚                        â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                                                             â”‚
â”‚  Data Flow:                                                                 â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€   â”‚
â”‚                                                                             â”‚
â”‚  Physics Thread â”€â”€[qpos, qvel]â”€â”€> Control Thread                           â”‚
â”‚  Control Thread â”€â”€[torques]â”€â”€â”€â”€â”€> Physics Thread (sim->d_->ctrl)           â”‚
â”‚  Physics Thread â”€â”€[observation]â”€> MPC Thread (setCurrentObservation)       â”‚
â”‚  MPC Thread â”€â”€â”€â”€â”€[policy]â”€â”€â”€â”€â”€â”€â”€> Control Thread (evaluatePolicy)          â”‚
â”‚                                                                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ“Š Data Structures

### State Vector (24 dimensions)

```cpp
// OCS2 Centroidal State Vector (24 elements)
// Index    Meaning                     Units
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// [0-2]    Normalized linear momentum  [m/s]     (vcom_x, vcom_y, vcom_z)
// [3-5]    Normalized angular momentum [rad/s]   (L_x, L_y, L_z) / mass
// [6-8]    Base position              [m]        (x, y, z)
// [9-11]   Base orientation (ZYX)     [rad]      (yaw, pitch, roll)
// [12-14]  LF joint angles            [rad]      (HAA, HFE, KFE)
// [15-17]  LH joint angles            [rad]      (HAA, HFE, KFE)
// [18-20]  RF joint angles            [rad]      (HAA, HFE, KFE)
// [21-23]  RH joint angles            [rad]      (HAA, HFE, KFE)
```

### Input Vector (24 dimensions)

```cpp
// OCS2 Centroidal Input Vector (24 elements)
// Index    Meaning                     Units
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// [0-2]    LF contact force           [N]        (Fx, Fy, Fz)
// [3-5]    RF contact force           [N]        (Fx, Fy, Fz)
// [6-8]    LH contact force           [N]        (Fx, Fy, Fz)
// [9-11]   RH contact force           [N]        (Fx, Fy, Fz)
// [12-14]  LF foot velocity           [m/s]      (vx, vy, vz)
// [15-17]  LH foot velocity           [m/s]      (vx, vy, vz)
// [18-20]  RF foot velocity           [m/s]      (vx, vy, vz)
// [21-23]  RH foot velocity           [m/s]      (vx, vy, vz)
```

### RBD State Vector (36 dimensions)

```cpp
// Rigid Body Dynamics State Vector (36 elements)
// Used by Pinocchio and WBC
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// [0-2]    Base orientation (ZYX Euler)  [rad]
// [3-5]    Base position                 [m]
// [6-17]   Joint positions (OCS2 order)  [rad]
// [18-20]  Base angular velocity         [rad/s]
// [21-23]  Base linear velocity          [m/s]
// [24-35]  Joint velocities              [rad/s]
```

---

## ğŸ¦¿ Joint Ordering Convention

âš ï¸ **CRITICAL:** MuJoCo and OCS2 use **different joint orderings!**

```
                    JOINT ORDERING MAPPING
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                                                               â”‚
â”‚  MuJoCo Order:     LF(0-2), RF(3-5), LH(6-8), RH(9-11)       â”‚
â”‚  OCS2 Order:       LF(0-2), LH(3-5), RF(6-8), RH(9-11)       â”‚
â”‚                                                               â”‚
â”‚  Mapping:                                                     â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€   â”‚
â”‚  MuJoCo[0-2]  LF â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€> OCS2[0-2]  LF             â”‚
â”‚  MuJoCo[3-5]  RF â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€> OCS2[3-5]  LH             â”‚
â”‚  MuJoCo[6-8]  LH â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€> OCS2[6-8]  RF             â”‚
â”‚  MuJoCo[9-11] RH â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€> OCS2[9-11] RH             â”‚
â”‚                                                               â”‚
â”‚  Note: LH and RF are SWAPPED between frameworks!             â”‚
â”‚                                                               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ”„ Control Loop Timing

```
Time (seconds)
â”‚
â”‚  [0.0 - 3.0]  PD CONTROL ONLY
â”‚  â”œâ”€â”€ Robot stabilizes with default joint positions
â”‚  â”œâ”€â”€ No MPC, no WBC
â”‚  â”œâ”€â”€ Torque: Ï„ = Kp*(q_default - q) - Kd*v
â”‚  â””â”€â”€ Purpose: Allow physics to settle, avoid MPC instability
â”‚
â”‚  [3.0 +]  MPC + WBC CONTROL
â”‚  â”œâ”€â”€ MPC generates optimal state/input trajectory
â”‚  â”œâ”€â”€ WBC converts contact forces to joint torques
â”‚  â”œâ”€â”€ Torque: Ï„ = RNEA(q, v, a + PD_feedback, F_contact)
â”‚  â””â”€â”€ Purpose: Optimal standing with force regulation
â”‚
â–¼
```

---

## ğŸ¤– ANYmal C Robot Parameters

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                   ANYmal C Specifications                   â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  Total Mass:        52.1348 kg                              â”‚
â”‚  Standing Height:   0.575 m (CoM)                           â”‚
â”‚  Number of Legs:    4                                       â”‚
â”‚  DOF per Leg:       3 (HAA, HFE, KFE)                       â”‚
â”‚  Total DOF:         12 actuated joints                      â”‚
â”‚                                                             â”‚
â”‚  Joint Naming:                                              â”‚
â”‚  â”œâ”€â”€ HAA: Hip Abduction/Adduction                           â”‚
â”‚  â”œâ”€â”€ HFE: Hip Flexion/Extension                             â”‚
â”‚  â””â”€â”€ KFE: Knee Flexion/Extension                            â”‚
â”‚                                                             â”‚
â”‚  Leg Naming:                                                â”‚
â”‚  â”œâ”€â”€ LF: Left Front                                         â”‚
â”‚  â”œâ”€â”€ RF: Right Front                                        â”‚
â”‚  â”œâ”€â”€ LH: Left Hind                                          â”‚
â”‚  â””â”€â”€ RH: Right Hind                                         â”‚
â”‚                                                             â”‚
â”‚  Contact Model:     3-DoF point contacts (force only)       â”‚
â”‚  Friction Coef:     0.5 (in task.info)                      â”‚
â”‚                                                             â”‚
â”‚  Standing Contact Forces (per leg):                         â”‚
â”‚  Fz = mass * gravity / 4 = 52.1348 * 9.81 / 4 â‰ˆ 128 N      â”‚
â”‚                                                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ”‘ Key Classes and Their Roles

| Class | File | Role |
|-------|------|------|
| `LeggedRobotInterface` | `LeggedRobotInterface.cpp` | Loads config, creates OCP |
| `GaussNewtonDDP_MPC` | (OCS2 library) | MPC solver |
| `MPC_MRT_Interface` | (OCS2 library) | Thread-safe MPC interface |
| `CentroidalModelRbdConversions` | (OCS2 library) | WBC implementation |
| `PinocchioInterface` | (OCS2 library) | Dynamics computation |
| `mujoco::Simulate` | (MuJoCo library) | Simulation + GUI |

---

## ğŸ“ Global Variables in main_anymal_mujoco.cpp

```cpp
// MPC Interface Objects
std::unique_ptr<LeggedRobotInterface> robotInterface;  // OCS2 interface
std::unique_ptr<GaussNewtonDDP_MPC> mpcSolver;         // MPC solver
std::unique_ptr<MPC_MRT_Interface> mpcMrt;             // Real-time interface
std::unique_ptr<CentroidalModelRbdConversions> rbdConversions;  // WBC

// Thread Synchronization
std::atomic<bool> mpcReady{false};        // MPC initialization flag
std::atomic<bool> exitRequest{false};     // Exit signal
std::mutex g_mpcMutex;                    // MPC data protection
std::mutex g_torqueMutex;                 // Torque data protection

// Shared Data
vector_t g_optimalState;                  // Latest MPC state (24-dim)
vector_t g_optimalInput;                  // Latest MPC input (24-dim)
Eigen::Matrix<double, 12, 1> g_torques;   // Applied joint torques

// Control Parameters
constexpr double KP = 80.0;               // PD position gain
constexpr double KD = 2.0;                // PD velocity gain
constexpr double MAX_TORQUE = 80.0;       // Torque saturation [Nm]
constexpr bool USE_MPC_TRAJECTORY = true; // Enable MPC tracking
constexpr bool USE_WBC_TORQUE = true;     // Enable WBC
```

---

**Next:** [02_MATH_FOUNDATIONS.md](./02_MATH_FOUNDATIONS.md) - Mathematical Foundations
